name: create-rpi-image
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PUBLIC_KEY: ''
      ROBOT_NAME: ''
    steps:
      - run: |
          ssh-keygen -t ed25519 -f ./id_ed25519 -N ''
          echo "PUBLIC_KEY=$(cat ./id_ed25519.pub)" >> "$GITHUB_ENV"
          echo "ROBOT_NAME=$($GITHUB_EVENT_REPOSITORY_NAME%%_*)" >> "$GITHUB_ENV"
      - uses: octokit/request-action@v2.x
        id: add_deploy_key
        with:
          route: POST /repos/${{ github.repository }}/keys
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          title: ${{ env.ROBOT_NAME }}
          key: ${{ env.PUBLIC_KEY }}
          read_only: false
        env:
          GITHUB_TOKEN: ${{ secrets.ADMIN_PAT }}
